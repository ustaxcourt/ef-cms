# Logging in EF-CMS

Logs serve a number of important roles in the day-to-day support and operations of EF-CMS.

- Assist in providing quality end-user support
- Diagnose and debug user-reported issues
- Monitor, report, and diagnose thrown exceptions
- Audit privileged user actions to assist in investigations
- Provide for reproducibility of critical actions

## Logged events

In the spirit of [NIST 800-53 (Revision 4) AU-2](https://nvd.nist.gov/800-53/Rev4/control/au-2), this documentation indicates what (and where) events within the system are logged.

### Successful and unsuccessful account login events

This includes both successful and unsuccessful attempts of a user elevating their privilege.

- Infrastructure
  - AWS: Console and access key logins (and login failures) — [CloudTrail][cloudtrail] with event source: `signin.amazonaws.com`
  - AWS: User and processes assuming roles (and role assumption failures) — [CloudTrail][cloudtrail] with event source: `iam.amazonaws.com`
- Application
  - AWS: Cognito user login (and login failure) — ❌
    - [Logs are not available when using Cognito Hosted UI](https://docs.aws.amazon.com/cognito/latest/developerguide/logging-using-cloudtrail.html)
  - AWS: IAM policy granted to user from Cognito authorizer — [Kibana][kibana] with message: `Request authorized`
  - EF-CMS: Exchanging authorization codes for tokens (and failed exchanges) — ❌
    - [Logs are not available when using Cognito Hosted UI](https://docs.aws.amazon.com/cognito/latest/developerguide/logging-using-cloudtrail.html)

### All administrator activity

- Infrastructure
  - AWS: All console and access key activity — [CloudTrail][cloudtrail]
- Application
  - EF-CMS: All API requests – [Kibana][kibana] with message: `Request ended`.

### Policy change events

- Infrastructure
  - AWS: All console and access key activity — [CloudTrail][cloudtrail]
  - Terraform: Policies documented in source code, automated runs are logged in CircleCI — [CircleCI][circleci]
- Application
  - There is no policy management in EF-CMS.

### Account management events

- Infrastructure
  - AWS: IAM user management — [CloudTrail][cloudtrail] with event source: `iam.amazonaws.com`
  - AWS: Role and account management is done through Cognito API requests — ❌
    - Roles and user management are performed through Cognito directly, which despite documentation, appears not to be logging in CloudTrail for changes to users.
  - Terraform: Test accounts seeded into development environments are applied through Terraform — [CircleCI][circleci]
- Application
  - Authorization requires Cognito account management listed above
  - EF-CMS: Administrator activity to create user records is done through API request — [Kibana][kibana] with message: `Request ended`

### Data access, change, and deletion events

- Infrastructure
  - AWS: Cognito users and roles — ❌
    - Roles and user management are performed through Cognito directly, which despite documentation, appears not to be logging in CloudTrail for changes to users.
  - AWS: DynamoDB table and stream operations (changes to table entries are not logged) — [CloudTrail][cloudtrail] with event source: `dynamodb.amazonaws.com`
  - AWS: S3 bucket operations (changes to individual documents are not logged) — [CloudTrail][cloudtrail] with event source: `s3.amazonaws.com`
  - AWS: Elasticsearch cluster operations (changes to documents are not logged) — [CloudTrail][cloudtrail] with event source: `es.amazonaws.com`
  - AWS: CloudWatch log group modifications, deletion of logs — [CloudTrail][cloudtrail] with event source: `logs.amazonaws.com`
- Application
  - EF-CMS: All access, change, and deletions happen through API requests — [Kibana][kibana]
  - EF-CMS: Access to documents in S3 happens via generating signed download URLs (by API request) — [Kibana][kibana] with message containing: `document-download-url`
  - EF-CMS: Background processes log their invocations when performing work — [Kibana][kibana]

## Where logs are located

#### CloudTrail

CloudTrail provides audit logs as generated by AWS, and are visible within the [CloudTrail console](https://aws.amazon.com/cloudtrail/).

#### Kibana

Logs which are generated by the EF-CMS application are logged in JSON to [CloudWatch](https://aws.amazon.com/cloudwatch/) which is then processed and indexed by [Kibana](https://docs.aws.amazon.com/elasticsearch-service/latest/developerguide/es-kibana.html).

#### CircleCI

Deployments including infrastructure changes are logged in [CircleCI](https://circleci.com/) build logs.

[cloudtrail]: #cloudtrail
[kibana]: #kibana
[circleci]: #circleci
